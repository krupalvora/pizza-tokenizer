<!DOCTYPE html>
<html>
<head>
  <title>Token Display</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="./supabase.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }
    .token-number {
      width: 80%;
      height: 80%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 15rem;
      line-height: 0.9;
      text-align: center;
      overflow: hidden;
    }
    
    @media (max-width: 1536px) {
      .token-number {
        font-size: 12rem;
      }
    }
    
    @media (max-width: 1280px) {
      .token-number {
        font-size: 10rem;
      }
    }
    
    @media (max-width: 1024px) {
      .token-number {
        font-size: 8rem;
      }
    }
    
    @media (max-width: 768px) {
      .token-number {
        font-size: 6rem;
      }
    }
    
    .grid > div {
      min-height: 0;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-blue-100 h-screen w-screen m-0 p-0 overflow-hidden">

  <div id="grid" class="grid gap-6 h-full w-full p-6"></div>

  <script>
    const grid = document.getElementById("grid");

    // Calculate optimal grid columns based on token count (consumer-friendly grid)
    function getGridCols(count) {
      if (count === 0) return "grid-cols-1";
      if (count === 1) return "grid-cols-1";
      if (count <= 4) return "grid-cols-2";
      if (count <= 9) return "grid-cols-3";
      if (count <= 16) return "grid-cols-4";
      if (count <= 25) return "grid-cols-5";
      if (count <= 36) return "grid-cols-6";
      // For more tokens, use responsive grid
      return "grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6";
    }

    // Render tile
    function tile(no) {
      return `
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white font-bold rounded-2xl flex flex-col justify-center items-center h-full shadow-2xl transform transition-all hover:scale-110 hover:shadow-blue-700/50 hover:rotate-1 border-4 border-blue-400">
          <div class="token-number">${no}</div>
        </div>
      `;
    }

    // Load ready tokens
    async function loadGrid() {
      const { data, error } = await supabase
        .from("tokens")
        .select("*")
        .eq("status", "ready")
        .order("token_no", { ascending: true });

      if (error) {
        console.error("Error loading tokens:", error);
        return;
      }

      const tokenCount = data.length;
      const colsClass = getGridCols(tokenCount);
      grid.className = `grid ${colsClass} gap-6 h-full w-full p-6`;

      if (tokenCount === 0) {
        grid.innerHTML = `
          <div class="col-span-full text-center text-blue-300 text-3xl bg-blue-50 rounded-2xl border-2 border-blue-200 border-dashed h-full flex items-center justify-center">
            <div class="text-6xl mb-4">Hey, Mht! your pizza üçï is getting ready...</div>
          </div>
        `;
      } else {
        grid.innerHTML = data.map(t => tile(t.token_no)).join("");
      }
    }

    // Voice announcement function
    function announceToken(tokenNo) {
      // Check if browser supports speech synthesis
      if ('speechSynthesis' in window) {
        // Cancel any ongoing speech
        speechSynthesis.cancel();
        
        // Create speech utterance
        const utterance = new SpeechSynthesisUtterance(`Token number ${tokenNo}`);
        utterance.volume = 1.0;
        utterance.rate = 0.9;
        utterance.pitch = 1.0;
        
        // Speak the announcement
        speechSynthesis.speak(utterance);
        console.log(`Voice announcement: Token number ${tokenNo} is ready`);
      } else {
        console.warn('Speech synthesis not supported in this browser');
      }
    }

    // Realtime updates for tokens
    supabase
      .channel("display")
      .on("postgres_changes", { event: "*", schema: "public", table: "tokens" }, () => {
        loadGrid();
      })
      .subscribe();

    // Listen for token announcements via broadcast (no database storage)
    supabase
      .channel("token-announcements")
      .on("broadcast", { event: "token-announcement" }, (payload) => {
        if (payload.payload && payload.payload.token_no) {
          announceToken(payload.payload.token_no);
        }
      })
      .subscribe();

    // Initial load
    loadGrid();
  </script>

</body>
</html>
